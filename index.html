<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Collatz GPU</title>
</head>
<body>
    <h1>Collatz at Home</h1>
    <p id="webgpu-status">Checking WebGPU support...</p>
    <input type="text" id="startN" value="1" placeholder="Starting number">
    <button id="runBtn" disabled>Run GPU Collatz</button>
    <pre id="output"></pre>
    
    <script type="module">
        import init, { do_gpu_collatz, check_webgpu_support } from './collatz_at_home.js';
        
        const output = document.getElementById('output');
        const status = document.getElementById('webgpu-status');
        const runBtn = document.getElementById('runBtn');
        
        async function main() {
            output.textContent = 'Loading WASM...';
            
            // Check native WebGPU first
            if (!navigator.gpu) {
                status.textContent = '❌ WebGPU not available in this browser. Try Chrome 113+ or Edge 113+';
                status.style.color = 'red';
                output.textContent = 'WebGPU is required but not supported.';
                return;
            }
            
            try {
                await init();
                output.textContent = 'WASM loaded!';
                
                const supported = await check_webgpu_support();
                if (supported) {
                    status.textContent = '✅ WebGPU supported!';
                    status.style.color = 'green';
                    runBtn.disabled = false;
                } else {
                    status.textContent = '❌ WebGPU adapter not found';
                    status.style.color = 'red';
                }
            } catch (e) {
                output.textContent = 'Error loading WASM: ' + e;
                console.error(e);
            }
        }
        
        runBtn.addEventListener('click', async () => {
            const startN = document.getElementById('startN').value;
            output.textContent = 'Running GPU Collatz...';
            try {
                let a = await do_gpu_collatz(startN);
                

                const payload = { start: startN, results: a };

                await fetch("/results", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // not sure if stringify is necessary
                    body: JSON.stringify(payload),
                });

                output.textContent = 'Done!';

            } catch (e) {
                output.textContent = 'Error: ' + e;
                console.error(e);
            }
        });
        
        main();
    </script>
</body>
</html>